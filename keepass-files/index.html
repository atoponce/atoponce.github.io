<!doctype html>
<html>
  <head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Visual KeePass Key File Generator</title>
    <style>
      .dot {
        background-color: white;
        border: 1px solid black;
        border-radius: 50%;
        display: inline-block;
        height: 25px;
        margin-bottom: -4px;
        width: 25px;
      }
      .black {
        background-color: black;
      }
      .break {
          flex-basis: 100%;
          height: 0;
      }
      .rotate90 {
        transform: rotate(90deg);
      }
      .rotate180 {
        transform: rotate(180deg);
      }
      .rotate270 {
        transform: rotate(270deg);
      }
      #container {
        margin: 0 auto;
        width: 637px;
      }
      #tileTable {
        border-collapse: separate;
        border-spacing: 1px;
        display: table;
      }
      #tableBody {
        display: table-row-group;
      }
      .tableRow {
        display: table-row
      }
      .tableCell {
        background-color: #f3e2cf;
        border: 2px solid black;
        border-radius: 15%;
        color: black;
        display: table-cell;
        padding: 10px;
        vertical-align: middle;
        height: 81px;
        width: 81px;
      }
    </style>
    <script src='js/html2canvas.min.js'></script>
    <script>

      function secRand (count) {
        const min = (-count >>> 0) % count;
        const rand = new Uint32Array(1);
        const crypto = window.crypto || window.msCrypto;

        do { crypto.getRandomValues(rand); } while (rand[0] < min);

        return rand[0] % count;
      }
      function shuffleTiles (tiles) {
        for (let i = 0; i < tiles.length; i++) {
          const randInt = secRand(tiles.length);
          const tmp = tiles[randInt];
          tiles[randInt] = tiles[i];
          tiles[i] = tmp;
        }
        return tiles;
      }
      function resetCells () {
        for (let i = 0; i < 36; i++) {
          const cell = document.getElementById('cell' + i);

          for (let i = 0; i < 9; i++) cell.removeChild(cell.childNodes[0]);
        }
      }
      function rotateCells () {
        for (let i = 0; i < 36; i++) {
          const cell = document.getElementById('cell' + i);
          const randInt = secRand(4);

          if (randInt === 0) {
            cell.setAttribute('class', 'tableCell');
          } else if (randInt === 1) {
            cell.setAttribute('class', 'tableCell');
            cell.classList.add('rotate90');
          } else if (randInt === 2) {
            cell.setAttribute('class', 'tableCell');
            cell.classList.add('rotate180');
          } else {
            cell.setAttribute('class', 'tableCell');
            cell.classList.add('rotate270');
          }
        }
      }

      function drawDots () {
        // https://redd.it/km1gfh/
        const tiles = shuffleTiles([
          [  1, 510], [  2, 509], [  3, 508], [  5, 506], [  6, 505], [  7, 504],
          [ 10, 501], [ 11, 500], [ 12, 499], [ 13, 498], [ 14, 497], [ 15, 496], 
          [ 17, 494], [ 18, 493], [ 19, 492], [ 21, 490], [ 22, 489], [ 23, 488], 
          [ 26, 485], [ 27, 484], [ 28, 483], [ 29, 482], [ 30, 481], [ 33, 478], 
          [ 35, 476], [ 37, 474], [ 39, 472], [ 41, 470], [ 42, 469], [ 43, 468], 
          [ 44, 467], [ 45, 466], [ 46, 465], [ 49, 462], [ 51, 460], [ 53, 458], 
          [ 57, 454], [ 58, 453], [ 59, 452], [ 60, 451], [ 61, 450], [ 62, 449], 
          [ 69, 442], [ 70, 441], [ 76, 435], [ 78, 433], [ 85, 426], [ 86, 425], 
          [ 92, 419], [ 94, 417], [ 97, 414], [ 98, 413], [ 99, 412], [101, 410], 
          [106, 405], [113, 398], [114, 397], [141, 370], [142, 369], [158, 353]
        ]);

        for (let i = 0; i < 36; i++) {
          let tile;
          const cell = document.getElementById('cell' + i);

          if (secRand(2) === 0) tile = tiles[i][0].toString(2).padStart(9, '0');
          else tile = tiles[i][1].toString(2).padStart(9, '0');

          for (let i = 0; i < 9; i++) {
            const newSpan = document.createElement('span');
            newSpan.setAttribute('class', 'dot');
            if (tile[i] === '1') newSpan.classList.add('black');
            cell.appendChild(newSpan);
          }
        }
        rotateCells();
      }
      window.onload = function () {
        drawDots();
      };
    </script>
  </head>
  <body>
    <div id='container'>
      <h1>Visual KeePass Key Files</h1>
      <p>The <a href="https://keepass.info">KeePass password manager</a> and many variants <a href="https://keepass.info/help/base/keys.html#keyfiles">support key files</a> to enhance the security of your encrypted vault. It's usually an XML file with builtin hash integrity or just a 128-byte binary file. But this is boring.</p>
      <p>KeePass, KeePassXC, and many others support any file type. So long as the file is unique and sufficiently secure to be used as a secret cryptographic key, it'll work. So why not have some fun with it?</p>
      <p>Below is a random selection of 36 <a href="https://github.com/nsg21/PasswordRunes">Password Runes</a> from 60 double-sided tiles. See <a href="tiles.html">this security analysis</a> for more details.</p>
      <p>Right-click to save image.</p>
      <div id='tileTable'>
        <div id='tableBody'>
          <div class='tableRow'>
            <div id='cell0' class='tableCell'></div>
            <div id='cell1' class='tableCell'></div>
            <div id='cell2' class='tableCell'></div>
            <div id='cell3' class='tableCell'></div>
            <div id='cell4' class='tableCell'></div>
            <div id='cell5' class='tableCell'></div>
          </div>
          <div class='tableRow'>
            <div id='cell6' class='tableCell'></div>
            <div id='cell7' class='tableCell'></div>
            <div id='cell8' class='tableCell'></div>
            <div id='cell9' class='tableCell'></div>
            <div id='cell10' class='tableCell'></div>
            <div id='cell11' class='tableCell'></div>
          </div>
          <div class='tableRow'>
            <div id='cell12' class='tableCell'></div>
            <div id='cell13' class='tableCell'></div>
            <div id='cell14' class='tableCell'></div>
            <div id='cell15' class='tableCell'></div>
            <div id='cell16' class='tableCell'></div>
            <div id='cell17' class='tableCell'></div>
          </div>
          <div class='tableRow'>
            <div id='cell18' class='tableCell'></div>
            <div id='cell19' class='tableCell'></div>
            <div id='cell20' class='tableCell'></div>
            <div id='cell21' class='tableCell'></div>
            <div id='cell22' class='tableCell'></div>
            <div id='cell23' class='tableCell'></div>
          </div>
          <div class='tableRow'>
            <div id='cell24' class='tableCell'></div>
            <div id='cell25' class='tableCell'></div>
            <div id='cell26' class='tableCell'></div>
            <div id='cell27' class='tableCell'></div>
            <div id='cell28' class='tableCell'></div>
            <div id='cell29' class='tableCell'></div>
          </div>
          <div class='tableRow'>
            <div id='cell30' class='tableCell'></div>
            <div id='cell31' class='tableCell'></div>
            <div id='cell32' class='tableCell'></div>
            <div id='cell33' class='tableCell'></div>
            <div id='cell34' class='tableCell'></div>
            <div id='cell35' class='tableCell'></div>
          </div>
        </div> <!-- tableBody -->
      </div> <!-- tileTable -->
      <div class='break'></div>
      <button onclick='resetCells(); drawDots()'>Generate New</button>
    </div> <!-- container -->
    <script>
      function save() {
        const elementToSave = document.querySelector("#tableBody");

        document.addEventListener("contextmenu", () => {
          html2canvas(elementToSave).then(canvas => {
            const a = document.createElement("a");
            a.href = canvas.toDataURL("image/png");
            a.download = "keyfile.png";
            a.click();
          });
        });
      }

      save();
    </script>
  </body>
</html>
